---
title: "Data Cleaning and Exploration"
output: html_document
---
```{r}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

```{r}
library(tidyverse)         # for reading in data, graphing, and cleaning
library(tidymodels)        # for modeling ... tidily
library(usemodels)         # for suggesting step_XXX() functions
library(glmnet)            # for regularized regression, including LASSO
library(naniar)            # for examining missing values (NAs)
library(lubridate)         # for date manipulation
library(moderndive)        # for King County housing data
library(vip)               # for variable importance plots
library(rmarkdown)         # for paged tables
library(readr)
library(fastDummies)
library(kableExtra)
theme_set(theme_minimal()) # my favorite ggplot2 theme :)
```



```{r}
finalDATASET <- read_csv("FINALDATASET.csv")
```

```{r}
final_data <- finalDATASET %>% 
  dummy_cols(select_columns = "Sector") %>% 
  # mutate_at(vars(matches("Sector")),~as.factor(.)) %>% 
  # convert Macro factors from characters to numeric
  mutate(across(c("CPALTT01USM657N_PC1","GDP","GDP_PC1","T10Y2Y","M1SL_PC1","M1SL"),
                as.numeric)) %>% 
  group_by(YEAR,Sector) %>% 
  mutate(across(c(DEBTS,INVESTMENTS,CASH,VOLUME,EARNINGS,COGS,SALES,RECEIVABLE,INVENTORY),~replace(.,.==0,median(.)))) %>% 
  # delete less important factors -> Exchange can possibily be deleted
  ungroup() %>%  
  mutate(across(c(!where(is.numeric),-"COMPANY",-"Name"),as.factor)) %>% 
  select(-Earnings_next_year) %>% 
  drop_na()
```


```{r}
final_data <- final_data %>% 
  drop_na()
```



```{r}
final_data %>% 
  select(where(is.numeric)) %>% 
  summary() %>% 
  kbl()

final_data %>% 
  select(!where(is.numeric)) %>% 
  summary() %>% 
  kbl()
```

```{r}

  final_data %>% 
  select(where(is.numeric)) %>% 
  select(0:12) %>% 
  pivot_longer(cols = everything(),
               names_to = "variable", 
               values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30) +
  facet_wrap(vars(variable), 
             scales = "free",
             nrow = 3,
             ncol=4)

 final_data %>% 
  select(where(is.numeric)) %>% 
  select(13:21) %>% 
  pivot_longer(cols = everything(),
               names_to = "variable", 
               values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30) +
  facet_wrap(vars(variable), 
             scales = "free",
             nrow = 3)
 
 # final_data %>%
 #  select(where(is.numeric)) %>%
 #  select(25:31) %>%
 #  pivot_longer(cols = everything(),
 #               names_to = "variable",
 #               values_to = "value") %>%
 #  ggplot(aes(x = value)) +
 #  geom_histogram(bins = 30) +
 #  facet_wrap(vars(variable),
 #             scales = "free",
 #             nrow = 3,
 #             ncol=4)

 #  final_data %>% 
 #  select(where(is.numeric)) %>% 
 #  #select(37:41) %>% 
 #  pivot_longer(cols = everything(),
 #               names_to = "variable", 
 #               values_to = "value") %>% 
 #  ggplot(aes(x = value)) +
 #  geom_histogram(bins = 30) +
 #  facet_wrap(vars(variable), 
 #             scales = "free",
 #             nrow = 3,
 #             ncol=4)



```
```{r}
final_data %>% 
  select(where(is.factor)) %>% 
  pivot_longer(cols = everything(),
               names_to = "variable", 
               values_to = "value") %>% 
  ggplot(aes(x = value)) +
  geom_bar() +
  facet_wrap(vars(variable), 
             scales = "free", 
             nrow = 4)
```
```{r}
final_data %>%
  ggplot(aes(x = PROFIT)) +
  geom_boxplot(aes(color = Sector),
             alpha = .8,
             size = 1)
  
```
```{r}
final_data %>% 
  ggplot(aes(x = COGS, y = PROFIT)) + 
  geom_point()
```

